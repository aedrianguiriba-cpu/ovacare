# Supabase Schema (Main App)

Use the SQL below in the Supabase SQL editor. It matches the main app's current data model.

## Tables

```sql
-- Menstrual cycles
create table if not exists menstrual_cycles (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  start_date date not null,
  end_date date not null,
  flow int,
  notes text,
  created_at timestamptz default now()
);

-- Symptoms
create table if not exists symptoms (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  logged_at timestamptz default now(),
  mood text,
  cramps int,
  acne boolean default false,
  bloating boolean default false,
  hair_growth boolean default false,
  irregular boolean default false,
  severity int default 1
);

-- Medications
create table if not exists medications (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  name text not null,
  dose text not null,
  times text[] default '{}'::text[],
  taken boolean[] default '{}'::boolean[],
  created_at timestamptz default now()
);

-- Hydration tracking
create table if not exists hydration (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  amount numeric not null,
  unit text default 'ml',
  logged_at timestamptz default now(),
  created_at timestamptz default now()
);

-- Weight tracking
create table if not exists weight_entries (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade,
  weight numeric not null,
  unit text default 'kg',
  logged_at timestamptz default now(),
  created_at timestamptz default now()
);

-- Forum posts
create table if not exists forum_posts (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete set null,
  author text not null,
  title text not null,
  content text not null,
  tags text[] default '{}'::text[],
  posted_at timestamptz default now(),
  upvotes int default 0,
  downvotes int default 0,
  comments_count int default 0,
  relevance_score numeric,
  primary_topic text,
  detected_terms text[] default '{}'::text[],
  is_pcos_relevant boolean default true
);

-- Forum comments
create table if not exists forum_comments (
  id bigint generated by default as identity primary key,
  post_id bigint references forum_posts(id) on delete cascade,
  parent_id bigint references forum_comments(id) on delete cascade,
  user_id uuid references auth.users(id) on delete set null,
  author text not null,
  content text not null,
  posted_at timestamptz default now(),
  upvotes int default 0,
  downvotes int default 0
);

-- User votes tracking (one upvote per user per post/comment)
create table if not exists user_votes (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  post_id bigint references forum_posts(id) on delete cascade,
  comment_id bigint references forum_comments(id) on delete cascade,
  vote_type int not null check (vote_type in (1, -1)), -- 1 for upvote, -1 for downvote
  voted_at timestamptz default now(),
  constraint user_votes_unique_post unique (user_id, post_id),
  constraint user_votes_unique_comment unique (user_id, comment_id),
  constraint user_votes_one_target check ((post_id is not null and comment_id is null) or (post_id is null and comment_id is not null))
);
```

## RLS Policies

```sql
-- Enable RLS
alter table menstrual_cycles enable row level security;
alter table symptoms enable row level security;
alter table medications enable row level security;
alter table hydration enable row level security;
alter table weight_entries enable row level security;
alter table forum_posts enable row level security;
alter table forum_comments enable row level security;
alter table user_votes enable row level security;

-- Health data policies
create policy "menstrual_cycles_read" on menstrual_cycles
  for select using (auth.uid() = user_id);
create policy "menstrual_cycles_write" on menstrual_cycles
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "symptoms_read" on symptoms
  for select using (auth.uid() = user_id);
create policy "symptoms_write" on symptoms
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "medications_read" on medications
  for select using (auth.uid() = user_id);
create policy "medications_write" on medications
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "hydration_read" on hydration
  for select using (auth.uid() = user_id);
create policy "hydration_write" on hydration
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

create policy "weight_entries_read" on weight_entries
  for select using (auth.uid() = user_id);
create policy "weight_entries_write" on weight_entries
  for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

-- Forum policies (public read, authenticated write/vote, owner update/delete)
-- Note: Two update policies allow (1) owner to update content and (2) any authenticated user to update votes/comments_count
-- The application ensures only vote fields are updated by non-owners
create policy "forum_posts_read" on forum_posts
  for select using (true);
create policy "forum_posts_insert" on forum_posts
  for insert with check (auth.uid() = user_id);
create policy "forum_posts_update_owner" on forum_posts
  for update using (auth.uid() = user_id);
create policy "forum_posts_update_votes" on forum_posts
  for update using (auth.uid() is not null);
create policy "forum_posts_delete" on forum_posts
  for delete using (auth.uid() = user_id);

create policy "forum_comments_read" on forum_comments
  for select using (true);
create policy "forum_comments_insert" on forum_comments
  for insert with check (auth.uid() = user_id);
create policy "forum_comments_update_owner" on forum_comments
  for update using (auth.uid() = user_id);
create policy "forum_comments_update_votes" on forum_comments
  for update using (auth.uid() is not null);
create policy "forum_comments_delete" on forum_comments
  for delete using (auth.uid() = user_id);

-- User votes policies (users can read all votes, insert/delete/update their own)
create policy "user_votes_read" on user_votes
  for select using (true);
create policy "user_votes_insert" on user_votes
  for insert with check (auth.uid() = user_id);
create policy "user_votes_delete" on user_votes
  for delete using (auth.uid() = user_id);
create policy "user_votes_update" on user_votes
  for update using (auth.uid() = user_id);
```
